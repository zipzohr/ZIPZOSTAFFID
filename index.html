<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Staff ID System (One File • Full Public)</title>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--muted:#667085;--line:#e5e7eb;--ink:#111827;}
  body{font-family:system-ui,Arial;margin:0;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1050px;margin:24px auto;padding:16px}
  .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
  .hide{display:none}
  h2{margin:0 0 10px}
  label{font-size:12px;color:var(--muted);display:block;margin:10px 0 6px}
  input,select,textarea,button{padding:10px 12px;border-radius:12px;border:1px solid var(--line);width:100%;box-sizing:border-box;font-size:14px}
  textarea{min-height:70px;resize:vertical}
  button{background:#111827;color:#fff;font-weight:800;cursor:pointer;border:0}
  button.secondary{background:#fff;color:#111827;border:1px solid var(--line)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:820px){.row{grid-template-columns:1fr}}
  .avatar{width:110px;height:110px;border-radius:14px;object-fit:cover;background:#eee;border:1px solid var(--line)}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:900}
  .ok{background:#e7f8ef;color:#067647}
  .bad{background:#ffe4e8;color:#b42318}
  .warn{background:#fff4c5;color:#8a6b00}
  .center{text-align:center;color:var(--muted)}
  .top{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
  .tiny{font-size:12px;color:var(--muted)}
  .hr{height:1px;background:var(--line);margin:14px 0}
  .btnRow{display:flex;gap:10px;flex-wrap:wrap}
  .btnRow > button{flex:1;min-width:160px}
  .kv{display:grid;grid-template-columns:220px 1fr;gap:10px;align-items:start}
  @media(max-width:720px){.kv{grid-template-columns:1fr}}
  .k{font-size:12px;color:var(--muted);font-weight:800}
  .v{font-size:14px;font-weight:650;word-break:break-word}
  #qr canvas{border-radius:12px;border:1px solid var(--line)}
  .warnBox{background:#fff4c5;border:1px solid #f5e6a4;border-radius:14px;padding:10px 12px}
</style>
</head>
<body>
<div class="wrap">

<!-- PUBLIC VIEW (QR scan) -->
<div class="card hide" id="publicView">
  <div class="warnBox tiny">
    ⚠️ You selected <b>FULL PUBLIC</b> view (shows all staff fields on QR scan).
    Make sure you have staff consent before publishing sensitive personal data.
  </div>
  <div class="hr"></div>
  <div class="center" id="publicLoading">Loading…</div>
</div>

<!-- ADMIN VIEW -->
<div class="card hide" id="adminView">
  <div class="top">
    <div>
      <h2>Admin • Staff Management</h2>
      <div class="tiny" id="who">Not signed in</div>
    </div>
    <div class="btnRow" style="max-width:420px">
      <button class="secondary" id="signOutBtn" type="button">Sign out</button>
      <button class="secondary" id="openPublicBtn" type="button">Open Public Link</button>
    </div>
  </div>

  <div class="warnBox tiny" style="margin-top:10px">
    ⚠️ Important: Open this file on <b>http/https</b> (Hosting or localhost). If you open with <b>file://</b>, photo upload will fail (CORS / origin null).
  </div>

  <div class="hr"></div>

  <div id="loginBox">
    <label>Email</label>
    <input id="email" type="email" placeholder="admin@company.com" autocomplete="username">
    <label>Password</label>
    <input id="password" type="password" placeholder="••••••••" autocomplete="current-password">
    <div class="btnRow" style="margin-top:12px">
      <button id="loginBtn" type="button">Login</button>
      <button class="secondary" id="resetBtn" type="button">Reset Password</button>
    </div>
  </div>

  <div id="adminBox" class="hide">
    <div class="row">
      <div>
        <label>Staff ID (Doc ID)</label>
        <input id="staffId" placeholder="007 or STF001">
      </div>
      <div>
        <label>Status</label>
        <select id="status">
          <option value="ACTIVE">ACTIVE</option>
          <option value="INACTIVE">INACTIVE</option>
          <option value="SUSPENDED">SUSPENDED</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Name (Myanmar)</label>
        <input id="nameMm" placeholder="ဟနင် ယဝိုင် ဇော်">
      </div>
      <div>
        <label>Name (English)</label>
        <input id="nameEn" placeholder="HNIN YAWAI ZAW">
      </div>
    </div>

    
    <div class="row">
      <div>
        <label>Father Name</label>
        <input id="fatherName" placeholder="အဖေ အမည် / Father name">
      </div>
      <div>
        <label>Education</label>
        <input id="education" placeholder="ပညာအရည်အချင်း / Education">
      </div>
    </div>


    <div class="row">
      <div>
        <label>Date of Birth (YYYY-MM-DD)</label>
        <input id="dob" placeholder="1999-01-31">
      </div>
      <div>
        <label>Age</label>
        <input id="age" placeholder="Auto" readonly>
      </div>
    </div>

    <label>Myanmar Address</label>
    <textarea id="addrMm" placeholder="Myanmar address..."></textarea>

    <label>Overseas Address</label>
    <textarea id="addrOs" placeholder="Thailand/Overseas address..."></textarea>

    <div class="row">
      <div>
        <label>NRC / ID Number</label>
        <input id="nrc" placeholder="(e.g., 12/XYZ(N)123456)">
      </div>
      <div>
        <label>Passport Number</label>
        <input id="passport" placeholder="AB1234567">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Position</label>
        <input id="position" placeholder="CUSTOMER SERVICE">
      </div>
      <div>
        <label>Department</label>
        <input id="department" placeholder="TRAVEL TOUR">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Phone</label>
        <input id="phone" placeholder="+66...">
      </div>
      <div>
        <label>Email</label>
        <input id="staffEmail" placeholder="staff@company.com">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Telegram ID</label>
        <input id="telegram" placeholder="@username">
      </div>
      <div>
        <label>Work Start Date (YYYY-MM-DD)</label>
        <input id="startDate" placeholder="2025-12-14">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Branch / Office</label>
        <input id="branch" placeholder="Bangkok">
      </div>
      <div>
        <label>Photo (upload)</label>
        <input type="file" id="photo" accept="image/*">
      </div>
    </div>

    <div style="margin:10px 0;display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <img id="preview" class="avatar" alt="photo preview"/>
      <div class="tiny" id="photoInfo">No photo selected</div>
    </div>

    <div class="btnRow" style="margin-top:10px">
      <button id="loadBtn" type="button" class="secondary">Load Existing</button>
      <button id="saveBtn" type="button">Save Staff</button>
      <button id="clearBtn" type="button" class="secondary">Clear</button>
    </div>

    <div class="hr"></div>

    <div>
      <label>QR Preview (Public Link)</label>
      <div id="qr"></div>
      <div class="btnRow" style="margin-top:10px">
        <button id="downloadQR" type="button" class="secondary">Download QR (PNG)</button>
        <button id="copyLink" type="button" class="secondary">Copy Link</button>
      </div>
      <div class="tiny" id="qrLink" style="margin-top:8px"></div>
    </div>
  </div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";
import QRCode from "https://cdn.jsdelivr.net/npm/qrcode@1.5.3/+esm";

// ====== CONFIG ======
// FULL PUBLIC MODE: shows ALL fields in QR scan view.
const FULL_PUBLIC_VIEW = true;

// ====== Firebase config ======
const firebaseConfig = {
  apiKey: "AIzaSyBMQJZ-NC8g9KWXm6OUy655stUxYM95vbE",
  authDomain: "staff-id-1035f.firebaseapp.com",
  projectId: "staff-id-1035f",
  storageBucket: "staff-id-1035f.firebasestorage.app",
  messagingSenderId: "804753008406",
  appId: "1:804753008406:web:c9bc7254f2b97f17419237"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const qs = new URLSearchParams(location.search);
const staffParam = (qs.get("id") || "").trim();

const publicView = document.getElementById("publicView");
const adminView = document.getElementById("adminView");

function pillClass(st){
  st = (st||"").toUpperCase();
  if (st === "ACTIVE") return "badge ok";
  if (st === "INACTIVE") return "badge bad";
  return "badge warn";
}
function esc(s=""){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function kvRow(k,v){
  const val = (v===undefined || v===null || v==="") ? "-" : esc(v);
  return `<div class="kv"><div class="k">${esc(k)}</div><div class="v">${val}</div></div>`;
}

/* ---------- PUBLIC MODE (QR scan) ---------- */
if (staffParam) {
  publicView.classList.remove("hide");

  const snap = await getDoc(doc(db, "staff", staffParam));
  if (!snap.exists()) {
    publicView.innerHTML = "<p class='center'>❌ Staff not found</p>";
  } else {
    const d = snap.data();

    const st = (d.status || "UNKNOWN").toUpperCase();
    const header = `
      <div style="display:flex;gap:14px;align-items:center;flex-wrap:wrap">
        <img src="${esc(d.photoUrl || "")}" class="avatar" onerror="this.style.display='none'"/>
        <div>
          <h2 style="margin:0">${esc(d.nameEn || d.nameMm || d.name || "-")}</h2>
          <div class="tiny" style="margin-top:4px">${esc(d.position || "-")} • ${esc(d.branch || "-")}</div>
          <div style="margin-top:8px"><span class="${pillClass(st)}">${esc(st)}</span></div>
        </div>
      </div>
      <div class="hr"></div>
    `;

    let body = "";
    if (FULL_PUBLIC_VIEW) {
      body = `
        ${kvRow("Staff ID", d.staffId || staffParam)}
        ${kvRow("Name (Myanmar)", d.nameMm)}
        ${kvRow("Name (English)", d.nameEn)}
        ${kvRow("Date of Birth", d.dob)}
        ${kvRow("Age", d.age)}
        ${kvRow("Father Name", d.fatherName)}
        ${kvRow("Education", d.education)}
        ${kvRow("Myanmar Address", d.addrMm)}
        ${kvRow("Overseas Address", d.addrOs)}
        ${kvRow("NRC / ID Number", d.nrc)}
        ${kvRow("Passport Number", d.passport)}
        ${kvRow("Position", d.position)}
        ${kvRow("Department", d.department)}
        ${kvRow("Phone", d.phone)}
        ${kvRow("Email", d.email)}
        ${kvRow("Telegram ID", d.telegram)}
        ${kvRow("Work Start Date", d.startDate)}
        ${kvRow("Branch / Office", d.branch)}
      `;
    } else {
      body = `
        ${kvRow("Staff ID", d.staffId || staffParam)}
        ${kvRow("Name (Myanmar)", d.nameMm)}
        ${kvRow("Name (English)", d.nameEn)}
        ${kvRow("Father Name", d.fatherName)}
        ${kvRow("Education", d.education)}
        ${kvRow("Position", d.position)}
        ${kvRow("Department", d.department)}
        ${kvRow("Branch / Office", d.branch)}
        ${kvRow("Work Start Date", d.startDate)}
      `;
    }

    publicView.innerHTML = `
      <div class="warnBox tiny">
        ⚠️ FULL PUBLIC view is ON. To hide sensitive data, set <code>FULL_PUBLIC_VIEW = false</code> in this file.
      </div>
      <div class="hr"></div>
      ${header}
      <div style="display:grid;gap:10px">${body}</div>
    `;
  }
}

/* ---------- ADMIN MODE ---------- */
else {
  adminView.classList.remove("hide");

  const who = document.getElementById("who");
  const signOutBtn = document.getElementById("signOutBtn");
  const openPublicBtn = document.getElementById("openPublicBtn");

  const email = document.getElementById("email");
  const password = document.getElementById("password");
  const loginBtn = document.getElementById("loginBtn");
  const resetBtn = document.getElementById("resetBtn");
  const loginBox = document.getElementById("loginBox");
  const adminBox = document.getElementById("adminBox");

  const staffId = document.getElementById("staffId");
  const status = document.getElementById("status");
  const nameMm = document.getElementById("nameMm");
  const nameEn = document.getElementById("nameEn");
  const dob = document.getElementById("dob");
  const age = document.getElementById("age");
  const fatherName = document.getElementById("fatherName");
  const education = document.getElementById("education");
  const addrMm = document.getElementById("addrMm");
  const addrOs = document.getElementById("addrOs");
  const nrc = document.getElementById("nrc");
  const passport = document.getElementById("passport");
  const position = document.getElementById("position");
  const department = document.getElementById("department");
  const phone = document.getElementById("phone");
  const staffEmail = document.getElementById("staffEmail");
  const telegram = document.getElementById("telegram");
  const startDate = document.getElementById("startDate");
  const branch = document.getElementById("branch");
  const photo = document.getElementById("photo");
  const preview = document.getElementById("preview");
  const photoInfo = document.getElementById("photoInfo");

  const loadBtn = document.getElementById("loadBtn");
  const saveBtn = document.getElementById("saveBtn");
  const clearBtn = document.getElementById("clearBtn");

  const qrDiv = document.getElementById("qr");
  const downloadQR = document.getElementById("downloadQR");
  const copyLink = document.getElementById("copyLink");
  const qrLink = document.getElementById("qrLink");

  let photoFile = null;
  let existingPhotoUrl = "";


  function calcAgeFromDob(dobStr){
    // dobStr: YYYY-MM-DD
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec((dobStr||"").trim());
    if(!m) return "";
    const y = parseInt(m[1],10);
    const mo = parseInt(m[2],10)-1;
    const da = parseInt(m[3],10);
    const now = new Date();
    let a = now.getFullYear() - y;
    const thisYearDob = new Date(now.getFullYear(), mo, da);
    if (now < thisYearDob) a -= 1;
    if (a < 0) return "";
    return String(a);
  }

  function syncAge(){
    const a = calcAgeFromDob(dob.value);
    age.value = a || "";
  }


  function currentPublicUrl(){
    const id = (staffId.value||"").trim();
    if(!id) return "";
    return `${location.origin}${location.pathname}?id=${encodeURIComponent(id)}`;
  }

  async function renderQR(){
    const url = currentPublicUrl();
    qrDiv.innerHTML = "";
    qrLink.textContent = url ? url : "";
    if(!url) return;

    const canvas = document.createElement("canvas");
    await QRCode.toCanvas(canvas, url, { width: 220, margin: 1 });
    qrDiv.appendChild(canvas);

    downloadQR.onclick = () => {
      const a = document.createElement("a");
      a.href = canvas.toDataURL("image/png");
      a.download = `QR_${(staffId.value||"STAFF").trim()}.png`;
      a.click();
    };
  }

  staffId.addEventListener("input", renderQR);
  renderQR();

  dob.addEventListener("input", syncAge);
  dob.addEventListener("change", syncAge);
  syncAge();

  copyLink.addEventListener("click", async ()=>{
    const url = currentPublicUrl();
    if(!url) return alert("Enter Staff ID first");
    await navigator.clipboard.writeText(url);
    alert("Copied link");
  });

  openPublicBtn.addEventListener("click", ()=>{
    const url = currentPublicUrl();
    if(!url) return alert("Enter Staff ID first");
    window.open(url, "_blank", "noopener");
  });

  photo.addEventListener("change", ()=>{
    photoFile = photo.files && photo.files[0] ? photo.files[0] : null;
    if (photoFile) {
      preview.src = URL.createObjectURL(photoFile);
      photoInfo.textContent = `Selected: ${photoFile.name}`;
    } else {
      photoInfo.textContent = "No photo selected";
    }
  });

  function clearForm(){
    staffId.value = "";
    status.value = "ACTIVE";
    nameMm.value = "";
    nameEn.value = "";
    dob.value = "";
    age.value = "";
    fatherName.value = "";
    education.value = "";
    addrMm.value = "";
    addrOs.value = "";
    nrc.value = "";
    passport.value = "";
    position.value = "";
    department.value = "";
    phone.value = "";
    staffEmail.value = "";
    telegram.value = "";
    startDate.value = "";
    branch.value = "";
    photo.value = "";
    photoFile = null;
    existingPhotoUrl = "";
    preview.src = "";
    photoInfo.textContent = "No photo selected";
    renderQR();
  }

  clearBtn.addEventListener("click", clearForm);

  loginBtn.addEventListener("click", async ()=>{
    try{
      await signInWithEmailAndPassword(auth, email.value.trim(), password.value);
    }catch(e){
      console.error(e);
      alert("Login failed");
    }
  });

  resetBtn.addEventListener("click", async ()=>{
    try{
      const em = email.value.trim();
      if(!em) return alert("Enter email first");
      await sendPasswordResetEmail(auth, em);
      alert("Reset email sent");
    }catch(e){
      console.error(e);
      alert("Reset failed");
    }
  });

  signOutBtn.addEventListener("click", async ()=>{
    await signOut(auth);
  });

  onAuthStateChanged(auth, (user)=>{
    if (!user){
      who.textContent = "Not signed in";
      loginBox.classList.remove("hide");
      adminBox.classList.add("hide");
      return;
    }
    who.textContent = `Signed in: ${user.email || user.uid}`;
    loginBox.classList.add("hide");
    adminBox.classList.remove("hide");
  });

  async function loadExisting(id){
    const snap = await getDoc(doc(db, "staff", id));
    if(!snap.exists()) return null;
    return snap.data();
  }

  loadBtn.addEventListener("click", async ()=>{
    const id = (staffId.value||"").trim();
    if(!id) return alert("Enter Staff ID first");
    const d = await loadExisting(id);
    if(!d) return alert("Staff not found");

    status.value = (d.status || "ACTIVE").toUpperCase();
    nameMm.value = d.nameMm || "";
    nameEn.value = d.nameEn || "";
    dob.value = d.dob || "";
    age.value = d.age || "";
    fatherName.value = d.fatherName || "";
    education.value = d.education || "";
    addrMm.value = d.addrMm || "";
    addrOs.value = d.addrOs || "";
    nrc.value = d.nrc || "";
    passport.value = d.passport || "";
    position.value = d.position || "";
    department.value = d.department || "";
    phone.value = d.phone || "";
    staffEmail.value = d.email || "";
    telegram.value = d.telegram || "";
    startDate.value = d.startDate || "";
    branch.value = d.branch || "";

    existingPhotoUrl = d.photoUrl || "";
    if(existingPhotoUrl){
      preview.src = existingPhotoUrl;
      photoInfo.textContent = "Existing photo loaded (upload new to replace)";
    } else {
      preview.src = "";
      photoInfo.textContent = "No photo on record";
    }
    // Auto-calc age from DOB if needed
    if ((dob.value||"").trim()) syncAge();
    await renderQR();
  });

  saveBtn.addEventListener("click", async ()=>{
    syncAge();
    const id = (staffId.value||"").trim();
    if(!id) return alert("Staff ID required");

    if (location.origin === "null") {
      return alert("Please open from Hosting or localhost (http/https). Do not open with file://");
    }

    let photoUrl = existingPhotoUrl || "";

    try{
      if (photoFile) {
        const ext = (photoFile.name.split(".").pop() || "jpg").toLowerCase();
        const sref = ref(storage, `staff/${encodeURIComponent(id)}.${ext}`);
        await uploadBytes(sref, photoFile, { contentType: photoFile.type || "image/jpeg" });
        photoUrl = await getDownloadURL(sref);
      }

      await setDoc(doc(db, "staff", id), {
        staffId: id,
        status: (status.value||"ACTIVE").toUpperCase(),
        nameMm: nameMm.value.trim(),
        nameEn: nameEn.value.trim(),
        dob: dob.value.trim(),
        age: (age.value||"").trim(),
        fatherName: fatherName.value.trim(),
        education: education.value.trim(),
        addrMm: addrMm.value.trim(),
        addrOs: addrOs.value.trim(),
        nrc: nrc.value.trim(),
        passport: passport.value.trim(),
        position: position.value.trim(),
        department: department.value.trim(),
        phone: phone.value.trim(),
        email: staffEmail.value.trim(),
        telegram: telegram.value.trim(),
        startDate: startDate.value.trim(),
        branch: branch.value.trim(),
        photoUrl: photoUrl,
        updatedAt: new Date().toISOString()
      }, { merge: true });

      existingPhotoUrl = photoUrl;
      alert("✅ Saved");
    }catch(e){
      console.error(e);
      alert("❌ Save failed. Check: (1) Hosting (not file://) (2) Firestore/Storage rules");
    }
  });
}
</script>
</body>
</html>
