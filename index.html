<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Staff ID System</title>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--muted:#667085;--line:#e5e7eb;--ink:#111827;}
  body{font-family:system-ui,Arial;margin:0;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1050px;margin:24px auto;padding:16px}
  .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
  .hide{display:none}
  h2{margin:0 0 10px}
  label{font-size:12px;color:var(--muted);display:block;margin:10px 0 6px}
  input,select,textarea,button{padding:10px 12px;border-radius:12px;border:1px solid var(--line);width:100%;box-sizing:border-box;font-size:14px}
  textarea{min-height:70px;resize:vertical}
  button{background:#111827;color:#fff;font-weight:800;cursor:pointer;border:0}
  button.secondary{background:#fff;color:#111827;border:1px solid var(--line)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media(max-width:820px){.row{grid-template-columns:1fr}}
  .avatar{width:110px;height:110px;border-radius:14px;object-fit:cover;background:#eee;border:1px solid var(--line)}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:900}
  .ok{background:#e7f8ef;color:#067647}
  .bad{background:#ffe4e8;color:#b42318}
  .warn{background:#fff4c5;color:#8a6b00}
  .center{text-align:center;color:var(--muted)}
  .top{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
  .tiny{font-size:12px;color:var(--muted)}
  .hr{height:1px;background:var(--line);margin:14px 0}
  .btnRow{display:flex;gap:10px;flex-wrap:wrap}
  .btnRow > button{flex:1;min-width:160px}
  .kv{display:grid;grid-template-columns:220px 1fr;gap:10px;align-items:start}
  @media(max-width:720px){.kv{grid-template-columns:1fr}}
  .k{font-size:12px;color:var(--muted);font-weight:800}
  .v{font-size:14px;font-weight:650;word-break:break-word}
  #qr canvas{border-radius:12px;border:1px solid var(--line)}
</style>
</head>
<body>
<div class="wrap">

<!-- PUBLIC VIEW -->
<div class="card hide" id="publicView">
  <div class="center" id="publicLoading">Loading…</div>
</div>

<!-- ADMIN VIEW -->
<div class="card hide" id="adminView">
  <div class="top">
    <h2>Admin • Staff Management</h2>
    <button class="secondary" id="signOutBtn">Sign out</button>
  </div>

  <div id="loginBox">
    <label>Email</label>
    <input id="email">
    <label>Password</label>
    <input id="password" type="password">
    <button id="loginBtn">Login</button>
  </div>

  <div id="adminBox" class="hide">
    <label>Staff ID</label>
    <input id="staffId">

    <label>Name (English)</label>
    <input id="nameEn">

    <label>Position</label>
    <input id="position">

    <label>Branch</label>
    <input id="branch">

    <label>Photo URL</label>
    <input id="photoUrl" placeholder="/photos/007.jpg">

    <img id="preview" class="avatar">

    <button id="saveBtn">Save</button>
  </div>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBMQJZ-NC8g9KWXm6OUy655stUxYM95vbE",
  authDomain: "staff-id-1035f.firebaseapp.com",
  projectId: "staff-id-1035f",
  messagingSenderId: "804753008406",
  appId: "1:804753008406:web:c9bc7254f2b97f17419237"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const qs = new URLSearchParams(location.search);
const staffParam = qs.get("id");

const publicView = document.getElementById("publicView");
const adminView = document.getElementById("adminView");

if (staffParam) {
  publicView.classList.remove("hide");
  const snap = await getDoc(doc(db, "staff", staffParam));
  if (!snap.exists()) {
    publicView.innerHTML = "<p class='center'>Staff not found</p>";
  } else {
    const d = snap.data();
    const photo = d.photoUrl || `${location.origin}${location.pathname.replace(/\/[^\/]*$/, "")}/photos/${staffParam}.jpg`;
    publicView.innerHTML = `
      <div class="center">
        <img src="${photo}" class="avatar"><br><br>
        <b>${d.nameEn || ""}</b><br>
        ${d.position || ""}<br>
        ${d.branch || ""}
      </div>
    `;
  }
} else {
  adminView.classList.remove("hide");
}

onAuthStateChanged(auth, user => {
  if (user) {
    document.getElementById("loginBox").classList.add("hide");
    document.getElementById("adminBox").classList.remove("hide");
  }
});

document.getElementById("loginBtn").onclick = async () => {
  await signInWithEmailAndPassword(auth, email.value, password.value);
};

document.getElementById("signOutBtn").onclick = () => signOut(auth);

document.getElementById("photoUrl").oninput = e => {
  document.getElementById("preview").src = e.target.value;
};

document.getElementById("saveBtn").onclick = async () => {
  const id = staffId.value.trim();
  const photoUrl = photoUrl.value.trim();
  await setDoc(doc(db, "staff", id), {
    nameEn: nameEn.value,
    position: position.value,
    branch: branch.value,
    photoUrl
  }, { merge: true });
  alert("Saved");
};
</script>
</body>
</html>
